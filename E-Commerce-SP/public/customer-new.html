<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Customer Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
  </head>

  <body class="bg-light">
    <div class="container my-4">
      <h1 class="text-center text-primary mb-4">Add Customer</h1>

      <!-- Add Customer Form -->
      <form id="customerForm" enctype="multipart/form-data">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Name</label>
            <input type="text" name="name" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Phone</label>
            <input type="text" name="phone" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">DOB</label>
            <input type="date" name="dob" class="form-control" required />
          </div>
          <div class="col-12">
            <label class="form-label">Address</label>
            <textarea name="address" class="form-control" required></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Photo</label>
            <input type="file" name="image" class="form-control" />
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary mt-3">
              Add Customer
            </button>
          </div>
        </div>
      </form>

      <!-- Edit Customer Form (Hidden by default) -->
      <div id="editFormContainer" class="mt-5" style="display: none;">
        <h1 class="text-center text-warning mb-4">Edit Customer</h1>
        <form id="editCustomerForm" enctype="multipart/form-data">
          <input type="hidden" name="id" id="editId">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input type="text" name="name" id="editName" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" name="email" id="editEmail" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input type="text" name="phone" id="editPhone" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">DOB</label>
              <input type="date" name="dob" id="editDob" class="form-control" required />
            </div>
            <div class="col-12">
              <label class="form-label">Address</label>
              <textarea name="address" id="editAddress" class="form-control" required></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Photo</label>
              <input type="file" name="image" class="form-control" />
              <small class="text-muted">Current photo: <span id="currentPhoto"></span></small>
              <input type="hidden" name="current_image" id="editCurrentImage">
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-warning mt-3">
                Update Customer
              </button>
              <button type="button" class="btn btn-secondary mt-3" onclick="cancelEdit()">
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Customer Table -->
      <h1 class="text-center text-success mt-5">Customer List</h1>
      <div class="table-responsive mt-3">
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>DOB</th>
              <th>Address</th>
              <th>Photo</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="customerTableBody">
            <!-- Rows added dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ✅ Link JS Modules -->
    <script type="module">
      import {
        fetchCustomers,
        addCustomer,
        updateCustomer,
        deleteCustomer,
      } from "./assets/js/api.js";

      // Load customers on page ready
      document.addEventListener("DOMContentLoaded", async () => {
        await loadCustomers();
      });

      // ✅ Add customer handler
      const form = document.getElementById("customerForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);

        try {
          const res = await addCustomer(formData);
          if (res.success) {
            alert("Customer added successfully!");
            form.reset();
            await loadCustomers();
          } else {
            alert("Failed to add customer! " + (res.message || ""));
          }
        } catch (error) {
          console.error("Error adding customer:", error);
          alert("Error adding customer. Please try again.");
        }
      });

      // ✅ Edit customer handler
      document.getElementById("editCustomerForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          const res = await updateCustomer(formData);
          if (res.success) {
            alert("Customer updated successfully!");
            cancelEdit();
            await loadCustomers();
          } else {
            alert("Failed to update customer! " + (res.message || ""));
          }
        } catch (error) {
          console.error("Error updating customer:", error);
          alert("Error updating customer. Please try again.");
        }
      });

      // ✅ Fetch and render customers
      async function loadCustomers() {
        try {
          const data = await fetchCustomers();
          const tbody = document.getElementById("customerTableBody");
          tbody.innerHTML = "";

          if (!data || data.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  No customers found. Add your first customer above.
                </td>
              </tr>
            `;
            return;
          }

          data.forEach((c, index) => {
            tbody.innerHTML += `
              <tr>
                <td>${index + 1}</td>
                <td>${c.name || 'N/A'}</td>
                <td>${c.email || 'N/A'}</td>
                <td>${c.phone || 'N/A'}</td>
                <td>${c.dob || 'N/A'}</td>
                <td>${c.address || 'N/A'}</td>
                <td>
                  ${c.image ? 
                    `<img src="../server/storage/uploads/${c.image}" width="60" height="60" class="rounded" alt="${c.name}">` : 
                    '<span class="text-muted">No image</span>'
                  }
                </td>
                <td>
                  <span class="badge ${c.isActive == 1 ? "bg-success" : "bg-danger"}">
                    ${c.isActive == 1 ? "Active" : "Inactive"}
                  </span>
                </td>
                <td>
                  <button class="btn btn-warning btn-sm" onclick="editCustomer(${c.id})">Edit</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteCustomerPrompt(${c.id})">Delete</button>
                </td>
              </tr>`;
          });
        } catch (error) {
          console.error("Error loading customers:", error);
          const tbody = document.getElementById("customerTableBody");
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center text-danger py-4">
                Error loading customers. Please check the console for details.
              </td>
            </tr>
          `;
        }
      }

      // ✅ Edit customer - populate form with current data
      async function editCustomer(id) {
        try {
          const data = await fetchCustomers();
          const customer = data.find(c => c.id == id);
          
          if (customer) {
            // Populate edit form
            document.getElementById('editId').value = customer.id;
            document.getElementById('editName').value = customer.name || '';
            document.getElementById('editEmail').value = customer.email || '';
            document.getElementById('editPhone').value = customer.phone || '';
            document.getElementById('editDob').value = customer.dob || '';
            document.getElementById('editAddress').value = customer.address || '';
            document.getElementById('currentPhoto').textContent = customer.image || 'default.jpg';
            document.getElementById('editCurrentImage').value = customer.image || 'default.jpg';
            
            // Show edit form, hide add form
            document.getElementById('editFormContainer').style.display = 'block';
            document.getElementById('customerForm').style.display = 'none';
            
            // Scroll to edit form
            document.getElementById('editFormContainer').scrollIntoView({ behavior: 'smooth' });
          }
        } catch (error) {
          console.error("Error editing customer:", error);
          alert("Error loading customer data. Please try again.");
        }
      }

      // ✅ Cancel edit and show add form
      function cancelEdit() {
        document.getElementById('editFormContainer').style.display = 'none';
        document.getElementById('customerForm').style.display = 'block';
        document.getElementById('editCustomerForm').reset();
      }

      // ✅ Delete customer
      async function deleteCustomerPrompt(id) {
        if (!confirm("Are you sure you want to delete this customer?")) return;
        
        try {
          // Create FormData for delete
          const formData = new FormData();
          formData.append('id', id);
          
          const res = await deleteCustomer(formData);
          if (res.success) {
            alert("Customer deleted successfully!");
            await loadCustomers();
          } else {
            alert("Failed to delete customer! " + (res.message || ""));
          }
        } catch (error) {
          console.error("Error deleting customer:", error);
          alert("Error deleting customer. Please try again.");
        }
      }

      // Make functions available globally
      window.editCustomer = editCustomer;
      window.deleteCustomerPrompt = deleteCustomerPrompt;
      window.cancelEdit = cancelEdit;
    </script>
  </body>
</html>