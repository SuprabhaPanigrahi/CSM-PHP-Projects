<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Products</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/a2d9d5ef3b.js"
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f4f6f9;
      }

      .navbar {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .page-header {
        margin-top: 100px;
        text-align: center;
      }

      .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .btn-custom {
        background-color: #5563de;
        color: white;
      }

      .btn-custom:hover {
        background-color: #3c4bcf;
        color: white;
      }

      .table thead {
        background-color: #5563de;
        color: white;
      }

      .table tbody tr:hover {
        background-color: #f0f3ff;
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top px-3">
      <a class="navbar-brand fw-bold" href="dashboard.html">MyShop Dashboard</a>
      <div class="ms-auto">
        <a href="product-view.html" class="btn btn-info btn-sm me-2">
          <i class="fas fa-eye"></i> View Products
        </a>
        <a href="dashboard.html" class="btn btn-outline-primary btn-sm me-2">
          <i class="fas fa-arrow-left"></i> Back
        </a>
        <a href="logout.php" class="btn btn-outline-danger btn-sm">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </nav>

    <div class="container pt-5">
      <div class="page-header mb-4">
        <h2><i class="fas fa-boxes"></i> Manage Products</h2>
        <p class="text-muted">
          Add, update, or delete products from your inventory.
        </p>
      </div>

      <!-- Product Form -->
      <div class="card mb-5">
        <div class="card-body">
          <h5 class="card-title mb-4">
            <i class="fas fa-plus-circle me-2"></i> Add / Edit Product
          </h5>

          <form id="productForm" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="id" id="editProductId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label for="productName" class="form-label">Product Name</label>
                <input
                  type="text"
                  id="productName"
                  name="productName"
                  class="form-control"
                  placeholder="Enter product name"
                  required
                />
              </div>

              <div class="col-md-6">
                <label for="category" class="form-label">Category</label>
                <select
                  name="category"
                  id="category"
                  class="form-control"
                  required
                >
                  <option value="">~~select~~</option>
                  <!-- categories will be populated here -->
                </select>
              </div>

              <div class="col-md-4">
                <label for="price" class="form-label">Price ($)</label>
                <input
                  type="number"
                  id="price"
                  name="price"
                  class="form-control"
                  step="0.01"
                  placeholder="Enter price"
                  required
                />
              </div>

              <div class="col-md-4">
                <label for="productCode" class="form-label">Product Code</label>
                <input
                  type="number"
                  id="productCode"
                  name="productCode"
                  class="form-control"
                  placeholder="Enter product code"
                  required
                />
              </div>

              <div class="col-md-4">
                <label for="stock" class="form-label">Stock Quantity</label>
                <input
                  type="number"
                  id="stock"
                  name="stock"
                  class="form-control"
                  placeholder="Enter stock quantity"
                  required
                />
              </div>

              <div class="col-md-6">
                <label for="purchasePrice" class="form-label">Purchase Price ($)</label>
                <input
                  type="number"
                  id="purchasePrice"
                  name="purchasePrice"
                  class="form-control"
                  step="0.01"
                  placeholder="Enter purchase price"
                  required
                />
              </div>

              <div class="col-md-6">
                <label for="discount" class="form-label">Discount (%)</label>
                <input
                  type="number"
                  id="discount"
                  name="discount"
                  class="form-control"
                  step="0.01"
                  placeholder="Enter discount percentage"
                />
              </div>

              <div class="col-md-6">
                <label for="sellingPrice" class="form-label">Selling Price ($)</label>
                <input
                  type="number"
                  id="sellingPrice"
                  name="sellingPrice"
                  class="form-control"
                  step="0.01"
                  placeholder="Enter selling price"
                  required
                />
              </div>

              <div class="col-md-6">
                <label for="productImage" class="form-label">Product Image</label>
                <input
                  type="file"
                  id="productImage"
                  name="productImage"
                  class="form-control"
                  accept="image/*"
                />
                <small class="text-muted">Current image: <span id="currentProductImage"></span></small>
                <input
                  type="hidden"
                  name="current_image"
                  id="editCurrentImage"
                />
              </div>

              <div class="col-md-12">
                <label for="description" class="form-label">Description</label>
                <textarea
                  id="description"
                  name="description"
                  class="form-control"
                  rows="3"
                  placeholder="Enter product description"
                ></textarea>
              </div>

              <div class="col-12 text-end mt-3">
                <button
                  type="reset"
                  class="btn btn-outline-secondary"
                  onclick="resetForm()"
                >
                  Reset
                </button>
                <button type="submit" class="btn btn-custom">
                  <i class="fas fa-save me-2"></i> Save Product
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Product Table -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-4">
            <i class="fas fa-list me-2"></i> Product List
          </h5>

          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Image</th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Price ($)</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <!-- products will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ‚úÖ Link JS Modules -->
    <script type="module">
      import {
        fetchProducts,
        addProduct,
        updateProduct,
        deleteProduct,
        fetchCategories,
      } from "./assets/js/api.js";

      // Load products and categories on page ready
      document.addEventListener("DOMContentLoaded", async () => {
        await loadCategories();
        await loadProducts();
        setupPriceCalculations();
      });

      // ‚úÖ Add/Edit product handler
      document
        .getElementById("productForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const productId = document.getElementById("editProductId").value;

          try {
            let res;
            if (productId) {
              console.log('‚úèÔ∏è Updating product ID:', productId);
              res = await updateProduct(formData);
            } else {
              console.log('‚ûï Adding new product');
              res = await addProduct(formData);
            }

            if (res.success) {
              alert(
                productId
                  ? "‚úÖ Product updated successfully!"
                  : "‚úÖ Product added successfully!"
              );
              resetForm();
              await loadProducts();
            } else {
              alert(
                (productId
                  ? "‚ùå Failed to update product! "
                  : "‚ùå Failed to add product! ") + (res.message || "")
              );
            }
          } catch (error) {
            console.error("üí• Error saving product:", error);
            alert("üí• Error saving product. Please try again.");
          }
        });

      // ‚úÖ Load and display products
      async function loadProducts() {
        try {
          const data = await fetchProducts();
          const tbody = document.getElementById("productsTableBody");
          tbody.innerHTML = "";

          if (!data || data.length === 0) {
            tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                No products found. Add your first product above.
              </td>
            </tr>
          `;
            return;
          }

          data.forEach((product, index) => {
            const row = `
            <tr>
              <td>${index + 1}</td>
              <td>
                ${
                  product.image && product.image !== 'default.jpg'
                    ? `<img src="../server/storage/products/${product.image}" width="50" height="50" class="rounded" alt="${product.name}">`
                    : '<i class="fas fa-image text-muted"></i>'
                }
              </td>
              <td>${product.name || "N/A"}</td>
              <td>${product.category_name || "N/A"}</td>
              <td>$${product.price ? parseFloat(product.price).toFixed(2) : "0.00"}</td>
              <td>
                <span class="badge ${
                  product.stock > 0 ? "bg-success" : "bg-danger"
                }">
                  ${product.stock || 0}
                </span>
              </td>
              <td>
                <button class="btn btn-warning btn-sm" onclick="editProduct(${
                  product.id
                })">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteProductPrompt(${
                  product.id
                })">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </td>
            </tr>`;
            tbody.innerHTML += row;
          });
        } catch (error) {
          console.error("üí• Error loading products:", error);
          const tbody = document.getElementById("productsTableBody");
          tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-danger py-4">
              Error loading products. Please check the console for details.
            </td>
          </tr>
        `;
        }
      }

      // ‚úÖ Load categories for dropdown
      async function loadCategories() {
        try {
          const categories = await fetchCategories();
          const categorySelect = document.getElementById("category");
          categorySelect.innerHTML = '<option value="">~~select~~</option>';

          console.log('üìã Categories loaded:', categories);

          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.id;
            option.textContent = cat.name;
            categorySelect.appendChild(option);
          });
        } catch (error) {
          console.error("üí• Error loading categories:", error);
        }
      }

      // ‚úÖ Edit product - populate form with current data
      async function editProduct(id) {
        try {
          console.log('‚úèÔ∏è EDIT: Product ID received:', id);
          const data = await fetchProducts();
          const product = data.find((p) => p.id == id);

          console.log('‚úèÔ∏è EDIT: Found product:', product);
          
          if (product) {
            // Populate edit form
            document.getElementById("editProductId").value = product.id;
            document.getElementById("productName").value = product.name || "";
            document.getElementById("category").value = product.categoryId || "";
            document.getElementById("price").value = product.price || "";
            document.getElementById("productCode").value = product.productCode || "";
            document.getElementById("purchasePrice").value = product.purchasePrice || "";
            document.getElementById("discount").value = product.discount || "";
            document.getElementById("sellingPrice").value = product.sellingPrice || "";
            document.getElementById("description").value = product.description || "";
            document.getElementById("currentProductImage").textContent = product.image || "No image";
            document.getElementById("editCurrentImage").value = product.image || "";

            console.log('‚úèÔ∏è EDIT: Form populated with ID:', product.id);
            
            // Scroll to form
            document.getElementById("productForm").scrollIntoView({ behavior: "smooth" });
          } else {
            alert("‚ùå Product not found!");
          }
        } catch (error) {
          console.error("üí• Error editing product:", error);
          alert("üí• Error loading product data. Please try again.");
        }
      }

      // ‚úÖ Delete product - FIXED VERSION
      async function deleteProductPrompt(id) {
        console.log('üóëÔ∏è DELETE: Product ID received:', id);
        
        if (!confirm("Are you sure you want to delete this product?")) return;

        try {
          console.log('üóëÔ∏è DELETE: Calling deleteProduct with ID:', id);
          
          // Send as JSON (not FormData)
          const res = await deleteProduct(id);
          
          console.log('üóëÔ∏è DELETE: Response received:', res);
          
          if (res.success) {
            alert("‚úÖ Product deleted successfully!");
            await loadProducts();
          } else {
            alert("‚ùå Failed to delete product! " + (res.message || ""));
          }
        } catch (error) {
          console.error("üí• DELETE: Error in delete prompt:", error);
          alert("üí• Error deleting product. Please check console for details.");
        }
      }

      // ‚úÖ Reset form
      function resetForm() {
        document.getElementById("editProductId").value = "";
        document.getElementById("currentProductImage").textContent = "";
        document.getElementById("editCurrentImage").value = "";
        document.getElementById("productForm").reset();
      }

      // ‚úÖ Auto-calculate selling price
      function setupPriceCalculations() {
        document.getElementById('purchasePrice').addEventListener('input', calculateSellingPrice);
        document.getElementById('discount').addEventListener('input', calculateSellingPrice);
      }

      function calculateSellingPrice() {
        const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        
        const discountAmount = purchasePrice * (discount / 100);
        const sellingPrice = purchasePrice - discountAmount;
        
        document.getElementById('sellingPrice').value = sellingPrice.toFixed(2);
      }

      // ‚úÖ Test function to check IDs
      function testProductIDs() {
        console.log('=== PRODUCT ID TEST ===');
        const tbody = document.getElementById("productsTableBody");
        const rows = tbody.querySelectorAll('tr');
        
        rows.forEach((row, index) => {
            const cells = row.querySelectorAll('td');
            const productName = cells[2].textContent;
            const editButton = cells[6].querySelector('.btn-warning');
            const deleteButton = cells[6].querySelector('.btn-danger');
            
            const editOnclick = editButton.getAttribute('onclick');
            const deleteOnclick = deleteButton.getAttribute('onclick');
            
            const editId = editOnclick.match(/editProduct\((\d+)\)/)?.[1];
            const deleteId = deleteOnclick.match(/deleteProductPrompt\((\d+)\)/)?.[1];
            
            console.log(`Product ${index + 1}: "${productName}"`);
            console.log(`  Edit ID: ${editId}, Delete ID: ${deleteId}`);
            console.log(`  Match: ${editId === deleteId ? '‚úÖ' : '‚ùå'}`);
        });
      }

      // Make functions available globally
      window.editProduct = editProduct;
      window.deleteProductPrompt = deleteProductPrompt;
      window.resetForm = resetForm;
      window.testProductIDs = testProductIDs;
    </script>
  </body>
</html>