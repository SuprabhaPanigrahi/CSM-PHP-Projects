<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Category Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
  </head>

  <body class="bg-light">
    <div class="container my-4">
      <h1 class="text-center text-primary mb-4">Add Category</h1>

      <!-- Add Category Form -->
      <form id="categoryForm" enctype="multipart/form-data">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Category Name</label>
            <input type="text" name="name" class="form-control" required />
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary mt-3">
              Add Category
            </button>
          </div>
        </div>
      </form>

      <!-- Edit Category Form (Hidden by default) -->
      <div id="editFormContainer" class="mt-5" style="display: none;">
        <h1 class="text-center text-warning mb-4">Edit Category</h1>
        <form id="editCategoryForm" enctype="multipart/form-data">
          <input type="hidden" name="id" id="editId">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Category Name</label>
              <input type="text" name="name" id="editName" class="form-control" required />
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-warning mt-3">
                Update Category
              </button>
              <button type="button" class="btn btn-secondary mt-3" onclick="cancelEdit()">
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Category Table -->
      <h1 class="text-center text-success mt-5">Category List</h1>
      <div class="table-responsive mt-3">
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Category Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="categoryTableBody">
            <!-- Rows added dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ✅ Link JS Modules -->
    <script type="module">
      import {
        fetchCategories,
        addCategory,
        updateCategory,
        deleteCategory,
      } from "./assets/js/api.js";

      // Load categories on page ready
      document.addEventListener("DOMContentLoaded", async () => {
        await loadCategories();
      });

      // ✅ Add category handler
      const form = document.getElementById("categoryForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);

        try {
          const res = await addCategory(formData);
          if (res.success) {
            alert("Category added successfully!");
            form.reset();
            await loadCategories();
          } else {
            alert("Failed to add category! " + (res.message || ""));
          }
        } catch (error) {
          console.error("Error adding category:", error);
          alert("Error adding category. Please try again.");
        }
      });

      // ✅ Edit category handler
      document.getElementById("editCategoryForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          const res = await updateCategory(formData);
          if (res.success) {
            alert("Category updated successfully!");
            cancelEdit();
            await loadCategories();
          } else {
            alert("Failed to update category! " + (res.message || ""));
          }
        } catch (error) {
          console.error("Error updating category:", error);
          alert("Error updating category. Please try again.");
        }
      });

      // ✅ Fetch and render categories
      async function loadCategories() {
        try {
          const data = await fetchCategories();
          console.log('Categories data:', data); // Debug log
          
          const tbody = document.getElementById("categoryTableBody");
          tbody.innerHTML = "";

          // Check if data is an array
          if (!data || !Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="4" class="text-center text-muted py-4">
                  No categories found. Add your first category above.
                </td>
              </tr>
            `;
            return;
          }

          data.forEach((cat, index) => {
            tbody.innerHTML += `
              <tr>
                <td>${index + 1}</td>
                <td>${cat.name || 'N/A'}</td>
                <td>
                  <button class="btn btn-warning btn-sm" onclick="editCategory(${cat.id})">Edit</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteCategoryPrompt(${cat.id})">Delete</button>
                </td>
              </tr>`;
          });
        } catch (error) {
          console.error("Error loading categories:", error);
          const tbody = document.getElementById("categoryTableBody");
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-danger py-4">
                Error loading categories. Please check if the API endpoint exists.
              </td>
            </tr>
          `;
        }
      }

      // ✅ Edit category - populate form with current data
      async function editCategory(id) {
        try {
          const data = await fetchCategories();
          console.log('Edit categories data:', data); // Debug log
          
          // Check if data is an array
          if (!data || !Array.isArray(data)) {
            alert("Error loading category data.");
            return;
          }
          
          const category = data.find(c => c.id == id);
          
          if (category) {
            // Populate edit form
            document.getElementById('editId').value = category.id;
            document.getElementById('editName').value = category.name || '';
            
            // Show edit form, hide add form
            document.getElementById('editFormContainer').style.display = 'block';
            document.getElementById('categoryForm').style.display = 'none';
            
            // Scroll to edit form
            document.getElementById('editFormContainer').scrollIntoView({ behavior: 'smooth' });
          } else {
            alert("Category not found!");
          }
        } catch (error) {
          console.error("Error editing category:", error);
          alert("Error loading category data. Please try again.");
        }
      }

      // ✅ Cancel edit and show add form
      function cancelEdit() {
        document.getElementById('editFormContainer').style.display = 'none';
        document.getElementById('categoryForm').style.display = 'block';
        document.getElementById('editCategoryForm').reset();
      }

      // ✅ Delete category
      async function deleteCategoryPrompt(id) {
        if (!confirm("Are you sure you want to delete this category?")) return;
        
        try {
          const res = await deleteCategory(id);
          if (res.success) {
            alert("Category deleted successfully!");
            await loadCategories();
          } else {
            alert("Failed to delete category! " + (res.message || ""));
          }
        } catch (error) {
          console.error("Error deleting category:", error);
          alert("Error deleting category. Please try again.");
        }
      }

      // Make functions available globally
      window.editCategory = editCategory;
      window.deleteCategoryPrompt = deleteCategoryPrompt;
      window.cancelEdit = cancelEdit;
    </script>
  </body>
</html>